---
name: Coding Standards
description: Development guidelines and best practices
globs: ["**/*.py", "src/**/*.{ts,tsx,js}"]
---

# Coding Standards

## Tech Stack
- **Backend**: Python 3.11+ with FastAPI
- **Frontend**: [To be determined - React/Next.js typical]
- **APIs**: Google Gemini, ElevenLabs, YouTube Data API, Google Veo

## Python/FastAPI Guidelines

### Project Structure
```
backend/
├── app/
│   ├── main.py              # FastAPI app entry point
│   ├── api/
│   │   └── v1/
│   │       ├── endpoints/   # Route handlers
│   │       └── deps.py      # Dependencies
│   ├── core/
│   │   ├── config.py        # Settings & env vars
│   │   └── security.py      # Auth if needed
│   ├── models/              # Pydantic models
│   ├── services/            # Business logic
│   │   ├── youtube.py
│   │   ├── gemini.py
│   │   ├── elevenlabs.py
│   │   ├── veo.py
│   │   └── remotion.py
│   └── utils/
├── tests/
└── requirements.txt
```

### Code Style
- Use **type hints** for all function signatures
- Follow **PEP 8** conventions
- Use **pydantic** for data validation
- Use **async/await** for I/O operations (API calls)
- Use **dependency injection** via FastAPI's Depends()

### Example Pattern
```python
from fastapi import APIRouter, Depends, HTTPException
from pydantic import BaseModel
from typing import List

router = APIRouter()

class PodcastRequest(BaseModel):
    topic: str
    num_references: int = 3

class PodcastResponse(BaseModel):
    episode_id: str
    status: str
    audio_url: str | None = None

@router.post("/generate", response_model=PodcastResponse)
async def generate_podcast(
    request: PodcastRequest,
    youtube_service: YouTubeService = Depends(get_youtube_service)
) -> PodcastResponse:
    try:
        # Business logic here
        pass
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

## API Integration Patterns

### Error Handling
- All external API calls must have try-except blocks
- Implement exponential backoff for retries
- Log all API errors with context
- Return meaningful error messages to client

### Environment Variables
```python
# core/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    youtube_api_key: str
    gemini_api_key: str
    elevenlabs_api_key: str
    veo_project_id: str

    class Config:
        env_file = ".env"

settings = Settings()
```

### Rate Limiting
- Implement rate limiting for external APIs
- Use redis or in-memory cache for tracking
- YouTube API: 10,000 units/day quota
- ElevenLabs: Character limits per request
- Veo: TBD based on quota

## Module Design

Each workflow step should be a service class:
```python
class TranscriptionService:
    async def get_transcript(self, video_id: str) -> str:
        """Fetch transcript from YouTube video."""
        pass
```

### Testing
- Use **pytest** for all tests
- Mock external APIs using **pytest-mock** or **responses**
- Write unit tests for each service
- Integration tests for full pipeline
- Test file location: `tests/` mirrors `app/` structure

## AI Prompt Engineering

### Prompt Templates
- Store prompts in `app/prompts/` directory
- Use Jinja2 templates for dynamic prompts
- Version control all prompts
- Include examples in prompts for better results

Example:
```python
# app/prompts/script_generation.py
SCRIPT_PROMPT = """
You are a professional podcast script writer.
Given the following outline, write a conversational script.

Outline:
{{ outline }}

Requirements:
- Natural, conversational tone
- Include transitions between topics
- Length: approximately {{ duration }} minutes
"""
```

## Video Generation Specifics

### Veo Prompts
- Always specify: "Cinematic lighting, photorealistic 4k, vertical 9:16 aspect ratio"
- Break scripts into 5-6 scenes (~5 seconds each)
- Generate scene descriptions using Gemini first

### Remotion Integration
- Use subprocess or API calls to trigger Remotion rendering
- Sync audio timeline with video components
- Output format: MP4, 1080x1920 (9:16)

## Security
- Never commit API keys to git
- Use `.env` file (gitignored) for local development
- Use environment variables in production
- Validate all user input with Pydantic
- Sanitize file uploads if applicable

## Dependencies
Key Python packages:
- `fastapi` - Web framework
- `uvicorn` - ASGI server
- `pydantic` - Data validation
- `httpx` - Async HTTP client
- `google-generativeai` - Gemini API
- `elevenlabs` - TTS API
- `google-cloud-aiplatform` - Veo/Vertex AI
- `google-api-python-client` - YouTube API
- `python-dotenv` - Environment variables
- `pytest` - Testing
